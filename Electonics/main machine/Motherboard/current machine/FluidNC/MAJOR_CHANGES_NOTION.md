# PolyPlot Firmware ‚Äî Major Changes (Notion Edition)

> üí° Quick reference for operators and developers. Paste this page into Notion or import the file (Markdown).

## Calibration quick start

- M155 ‚Äî Tool bank
  1) Send M155 to seek X+ then Y+, measure limits, map to negative-space, and persist Tool 1 plus autogenerated tools to `/spiffs/toolconfig.json`.
  2) Update Z later without motion with: `M155 Z-10.0` (example).
  3) The routine uses safe ‚Äúsystem motion,‚Äù won‚Äôt trigger soft-limit alarms, and returns to origin.

- M156 ‚Äî Work area / origin (interactive only)
  - P-modes only (no default full-auto):
    1) `M156 P1` ‚Äî Auto-measure from max: seeks X+ then Y+ and captures max.
    2) `M156 P2` ‚Äî Auto-measure from min: seeks X‚àí then Y‚àí and captures min.
    3) `M156 P3` ‚Äî Finalize: computes origin as (max ‚àí 0.02), rounds, writes config, restarts.

> ‚úÖ See `CALIBRATION.md` for full, step-by-step instructions.

---

## Tool change (M6 Tn)

- What: `M6 Tn` triggers a pen/tool change to tool n.
- Behavior: Executes a controlled system motion to the configured tool position; on failure, rolls back to the previous tool.
- Limits: Centralized handling ensures pen changes don‚Äôt trip soft-limit alarms; hard limits still apply.
- State: Current tool is persisted in `/spiffs/penstate.json`.

How it works

- Ensures tool configuration is loaded.
- Programs distinct approach vs precise feedrates and disables feed overrides for reproducibility.
- Synchronizes the planner buffer, runs the change, rolls back on error, and clears the modal flag.

---

## ATC JSON storage (Tool bank persistence)

- Files: `/spiffs/toolconfig.json` (array of tools), `/spiffs/penstate.json` (last known tool).
- API: `/toolconfig` GET/POST, `/toolconfig/status`.

JSON examples

```json
{
  "tools": [
    { "number": 1, "x": -30.2, "y": -100.0, "z": -10.0, "occupied": true },
    { "number": 2, "x": -30.2, "y": -110.0, "z": -10.0, "occupied": false }
  ]
}
```

```json
{ "currentPen": 1, "timestamp": 1712345678900 }
```

---

## ATC calibration (M155)

- Purpose: Measure Tool 1 X/Y from positive limits, map to negative-space relative to work origin; auto-generate tools 2‚Äì6; optionally set Z.
- Use:
  - Run `M155` for the XY calibration and tool bank generation.
  - Run `M155 Z-10.0` later to update Tool 1 Z only (no motion).
- Behavior: Returns to work origin after calibration; writes to toolconfig JSON.

How it works

- Z-only path: When a Z word is present, the parser updates Tool 1 Z and consumes Z so no motion is planned.
- Full calibration: Sets a non-modal ToolCalibration that enables ‚Äúsystem motion‚Äù so queued seeks can run without soft-limit prechecks.
- Limits handling: Limit trips during calibration are measurements, not alarms; hard limits still stop motion if configured.
- Coordinate math: Captures X+/Y+ machine positions, compensates per-axis pulloff, and maps into negative-space relative to `work_area.origin_x|origin_y`.
- Tool bank: Tool 1 is persisted exactly; additional tools are autogenerated with fixed spacing along negative Y for a consistent bank.

---

## Work area and work origin

- Config: `work_area` in `FluidNC/data/config.yaml` ‚Äî `min_x|min_y|max_x|max_y|origin_x|origin_y|enabled|move_to_origin`.
- Toggles: Enable or disable with M-codes below.
- Rounding: Values are kept to one decimal to avoid float residue near soft-limit edges.

### Work area toggles

- Enable: `M160`
- Disable: `M161`

---

## Work area calibration (M156)

- Purpose: Calibrate work origin and bounds interactively (three steps), with rounding to 0.1 mm and atomic persistence.
- Use:
  1) `M156 P1` to seek X+/Y+ and capture max.
  2) `M156 P2` to seek X‚àí/Y‚àí and capture min.
  3) `M156 P3` to compute origin (max ‚àí 0.02), persist, and restart.

How it works

- Motion flow: Seeks X+ limit, then Y+. On each limit, resets steppers/plan and records the machine position.
- Pulloff compensation: Corrects limit positions by pulloff to represent a safe working edge.
- Negative-space math: Origin is the negated, compensated max; mins come from the travel between start and max; maxes are origin minus a small guard band.
- Rounding: All values are rounded to 0.1 mm to eliminate floating residue.
- Atomic update: Resolves active config, rewrites `work_area`, writes a temporary file, renames to replace; then restarts so new limits take effect.

---

## Laser pointer offset (M150/M151)

- Config: `laser_offset_x`, `laser_offset_y` in `config.yaml`.
- Apply: `M150` (optionally with X/Y words to set values), Remove: `M151`.

How it works

- Offsets are applied to the parser‚Äôs coordinate offset vector (not a G92 move), preserving soft-limit validity.
- Removing clears the offset and disables auto-apply until re-enabled.
- Internal state notifications ensure UI reflects the new working offset.

---

## New limits system (tool + work area)

- Centralized: Soft-limit enforcement is unified; calibration and pen changes use ‚Äúsystem motion‚Äù and special routing so measured limit trips don‚Äôt alarm.
- Safety: Hard limits remain authoritative.

How it works

- State-aware limit routing: Homing ‚Üí ToolCalibration ‚Üí WorkAreaCalibration ‚Üí normal handling.
- During calibration, measured limits go to the active module. Otherwise, hard limits raise an alarm; soft limits are honored normally.
- Real-time reset aborts calibration cleanly (stop steppers, return to Idle).

---

## UI streaming and endpoints

- Minimal job-control UI at `/jobcontrol` (lightweight, SD-independent).
- Endpoints:
  - `/jobstatus` ‚Äî JSON job state
  - `/toolconfig` ‚Äî GET/POST tool bank
  - `/workorigin` ‚Äî work origin info
  - `/restart` ‚Äî restart MCU
  - `/command`, `/command_silent` ‚Äî G-code endpoints (existing)

---

## G-code dry run (check mode)

- Behavior: Parses/plans without moving motors to verify paths and limits.
- Use: Toggle FluidNC check mode using `$C` to enter/exit.

---

## Troubleshooting (quick)

- Float residue near edges ‚Üí Re-run `M156` to normalize with 0.1 mm rounding.
- Tool change fails ‚Üí Check toolconfig JSON, occupancy flags, and ensure positions are reachable; re-run `M155` if bank is out of date.
- Soft-limit alarm during calibration ‚Üí Ensure you invoked `M155`/`M156` (system motion path) not a manual move.
- Values not persisted ‚Üí Check free space on the local FS; confirm `config_filename` and that atomic rewrite succeeded.

---

## Quick commands

```text
M6 T1            ; Change to tool 1
M150 X-2.5 Y-1.0 ; Set and apply laser offset
M151             ; Remove laser offset
M155             ; Run tool calibration
M155 Z-10.0      ; Set tool Z only (no motion)
M156             ; Run work area/origin calibration
M160             ; Enable work area limits
M161             ; Disable work area limits
$C               ; Toggle check (dry run) mode
```

---

Related docs: `CALIBRATION.md` (step-by-step for M155/M156).
